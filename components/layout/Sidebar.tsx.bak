'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import {
  LayoutDashboard,
  ListTodo,
  Kanban,
  Users,
  Calendar,
  Settings,
  ChevronLeft,
  ChevronRight,
  Bot,
  Inbox,
  BarChart3,
  FolderGit2,
  CheckSquare,
  AlertCircle,
  Zap,
  MessageSquare,
  Clock,
  Target,
  Home
} from 'lucide-react'
import { PresenceDots } from '@/components/agents/PresenceIndicator'
import { useSidebar } from './SidebarContext'

interface NavItem {
  href: string
  icon: React.ReactNode
  label: string
  badge?: number
}

interface NavSection {
  title: string
  items: NavItem[]
}

const navSections: NavSection[] = [
  {
    title: 'Overview',
    items: [
      { href: '/', icon: <Home className="w-5 h-5" />, label: 'Home' },
      { href: '/dashboard', icon: <LayoutDashboard className="w-5 h-5" />, label: 'Dashboard' },
    ]
  },
  {
    title: 'Work',
    items: [
      { href: '/tasks', icon: <Inbox className="w-5 h-5" />, label: 'Tasks' },
      { href: '/board', icon: <Kanban className="w-5 h-5" />, label: 'Board' },
      { href: '/sprint', icon: <Target className="w-5 h-5" />, label: 'Sprints' },
    ]
  },
  {
    title: 'Monitor',
    items: [
      { href: '/sessions', icon: <Clock className="w-5 h-5" />, label: 'Sessions' },
      { href: '/agents', icon: <Bot className="w-5 h-5" />, label: 'Agents' },
      { href: '/chat', icon: <MessageSquare className="w-5 h-5" />, label: 'Chat' },
    ]
  },
  {
    title: 'Review',
    items: [
      { href: '/approvals', icon: <CheckSquare className="w-5 h-5" />, label: 'Approvals' },
      { href: '/issues', icon: <AlertCircle className="w-5 h-5" />, label: 'Issues' },
    ]
  },
  {
    title: 'Config',
    items: [
      { href: '/repositories', icon: <FolderGit2 className="w-5 h-5" />, label: 'Repos' },
      { href: '/settings', icon: <Settings className="w-5 h-5" />, label: 'Settings' },
    ]
  },
]

export function Sidebar() {
  const { collapsed, toggleCollapsed } = useSidebar()
  const pathname = usePathname()

  return (
    <aside 
      className={`fixed left-0 top-0 h-full bg-slate-900 border-r border-slate-800 flex flex-col z-40 transition-all duration-200 ${
        collapsed ? 'w-16' : 'w-56'
      }`}
    >
      {/* Logo */}
      <div className={`h-14 flex items-center border-b border-slate-800 ${collapsed ? 'justify-center px-2' : 'px-4'}`}>
        {collapsed ? (
          <Bot className="w-7 h-7 text-blue-500" />
        ) : (
          <Link href="/dashboard" className="flex items-center gap-2">
            <Bot className="w-7 h-7 text-blue-500" />
            <span className="font-bold text-lg">Ralph</span>
          </Link>
        )}
      </div>

      {/* Navigation */}
      <nav className="flex-1 overflow-y-auto py-4">
        {navSections.map((section, idx) => (
          <div key={section.title} className={idx > 0 ? 'mt-4' : ''}>
            {!collapsed && (
              <div className="px-4 mb-2 text-[10px] font-semibold text-slate-500 uppercase tracking-wider">
                {section.title}
              </div>
            )}
            
            <div className="space-y-0.5 px-2">
              {section.items.map((item) => {
                const isActive = pathname === item.href || 
                  (item.href !== '/' && pathname.startsWith(item.href))
                
                return (
                  <Link
                    key={item.href}
                    href={item.href}
                    className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ${
                      isActive
                        ? 'bg-blue-500/20 text-blue-400'
                        : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                    } ${collapsed ? 'justify-center' : ''}`}
                    title={collapsed ? item.label : undefined}
                  >
                    {item.icon}
                    {!collapsed && (
                      <>
                        <span className="flex-1 text-sm">{item.label}</span>
                        {item.badge !== undefined && item.badge > 0 && (
                          <span className="px-1.5 py-0.5 text-[10px] bg-blue-500 rounded-full">
                            {item.badge}
                          </span>
                        )}
                      </>
                    )}
                  </Link>
                )
              })}
            </div>
          </div>
        ))}
      </nav>

      {/* Agent Status */}
      <div className={`border-t border-slate-800 p-3 ${collapsed ? 'flex justify-center' : ''}`}>
        {collapsed ? (
          <PresenceDots />
        ) : (
          <div className="flex items-center gap-2 text-xs text-slate-500">
            <span>Agents:</span>
            <PresenceDots />
          </div>
        )}
      </div>

      {/* Collapse Toggle */}
      <button
        onClick={toggleCollapsed}
        className="absolute -right-3 top-20 w-6 h-6 bg-slate-800 border border-slate-700 rounded-full flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition-colors"
        title={collapsed ? 'Expand sidebar' : 'Collapse sidebar'}
      >
        {collapsed ? (
          <ChevronRight className="w-4 h-4" />
        ) : (
          <ChevronLeft className="w-4 h-4" />
        )}
      </button>
    </aside>
  )
}

export function MainContent({ children }: { children: React.ReactNode }) {
  const { collapsed, chatOpen } = useSidebar()
  
  return (
    <div className={`min-h-screen transition-all duration-200 ${collapsed ? "ml-16" : "ml-56"} ${chatOpen ? "pr-[420px]" : "pr-0"}`} style={{ "--chat-open": chatOpen ? 1 : 0 } as React.CSSProperties}>
      {children}
    </div>
  )
}
